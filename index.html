<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BHS Trespass Warnings</title>
  <style>
    :root { --brand:#8B1538; }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 10px;
      margin: 0;
    }
    .container {
      max-width: 520px;
      margin: 0 auto;
      background: var(--brand);
      border-radius: 25px;
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    .header { background: var(--brand); color: white; padding: 20px; }
    .title { font-size: 18px; font-weight: 600; margin: 0; }

    .content {
      background: white;
      border-radius: 25px 25px 0 0;
      min-height: 70vh;
      padding: 16px;
    }

    /* Controls */
    .controls {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }
    .search {
      display: flex; gap: 8px;
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
    }
    .search input {
      border: none; outline: none; background: transparent; width: 100%;
      font-size: 14px;
    }
    .status-select {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
    }
    .meta { font-size: 12px; color: #6b7280; margin: 6px 2px 12px; }

    /* Grid & cards */
    .trespass-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 460px) { .trespass-grid { grid-template-columns: 1fr; } }

    .trespass-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      cursor: pointer;
      padding: 12px;
      border: 1px solid #f3f4f6;
      transition: transform .06s ease;
    }
    .trespass-card:active { transform: scale(0.99); }

    .card-top {
      display: grid;
      grid-template-columns: 56px 1fr;
      gap: 10px;
      align-items: center;
      margin-bottom: 8px;
    }
    .avatar {
      width: 56px; height: 56px;
      border-radius: 8px; /* use 50% for circle */
      object-fit: cover;
      background: #f3f4f6;
      display: block;
    }
    .avatar--placeholder {
      width: 56px; height: 56px;
      border-radius: 8px;
      display: grid; place-items: center;
      font-size: 14px; color: #666;
      background: #f3f4f6;
    }
    .card-name { font-size: 15px; font-weight: 700; color: #111827; }
    .card-line { font-size: 12px; color: #6b7280; }

    .badge {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      margin-top: 8px;
      display: inline-block;
      user-select: none;
      font-weight: 600;
    }
    .badge-active  { background: #D1FAE5; color: #065F46; }   /* green */
    .badge-inactive{ background: #FEE2E2; color: #991B1B; }   /* red  */

    .empty { grid-column: 1 / -1; text-align: center; padding: 28px; color: #6b7280; }

    /* Modal */
    .modal {
      position: fixed; inset: 0; display: none;
      align-items: center; justify-content: center;
      background: rgba(0,0,0,0.45); z-index: 50;
      padding: 16px;
    }
    .modal.open { display: flex; }
    .modal-card {
      width: 100%; max-width: 560px;
      background: #fff; border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      overflow: hidden;
    }
    .modal-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px; background: var(--brand); color: #fff;
    }
    .modal-body { padding: 16px; }
    .detail-row { display: grid; grid-template-columns: 140px 1fr; gap: 8px; padding: 6px 0; font-size: 14px; }
    .detail-key { color: #6b7280; }
    .modal-actions { padding: 12px 16px; display: flex; justify-content: flex-end; gap: 8px; background: #f9fafb; }
    .btn {
      appearance: none; border: 1px solid #e5e7eb; background: #fff; color: #111827;
      padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: 600;
    }
    .btn-primary { background: var(--brand); color: #fff; border-color: var(--brand); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1 class="title">BHS Trespass Warnings</h1></div>

    <div class="content">
      <div class="controls">
        <div class="search" aria-label="Search">
          <input id="searchInput" type="search" placeholder="Search name, ID, guardian…" />
        </div>
        <select id="statusSelect" class="status-select" aria-label="Status filter">
          <option value="ALL">All</option>
          <option value="ACTIVE">Active</option>
          <option value="INACTIVE">Inactive</option>
        </select>
      </div>
      <div class="meta"><span id="resultCount">0</span> results</div>

      <div class="trespass-grid" id="trespassGrid"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="detailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div id="modalTitle" class="title" style="font-size:16px;">Details</div>
        <button class="btn" id="modalCloseBtn">Close</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
      <div class="modal-actions">
        <button class="btn-primary btn" id="modalOkBtn">OK</button>
      </div>
    </div>
  </div>

  <script>
    // ========= CONFIG =========
    const SHEET_ID = '10z83ZHY9p4uLPcbNwbxZw1x0gaYAE-AWQhsbIvjweKw';
    const GID = '0';

    let allData = [];
    let currentFiltered = [];

    // ========= Helpers =========
    function extractDriveId(url) {
      if (!url) return null;
      const m =
        url.match(/\/file\/d\/([^/]+)/) ||
        url.match(/[?&]id=([^&]+)/) ||
        url.match(/\/uc\?(?:export=[^&]*&)?id=([^&]+)/);
      return m ? m[1] : null;
    }
    function fromImageFormula(cellStr) {
      if (typeof cellStr !== 'string') return null;
      const m = cellStr.match(/^= *IMAGE\s*\(\s*"(https?:\/\/[^"]+)"\s*(?:,.*)?\)\s*$/i);
      return m ? m[1] : null;
    }
    function normalizeImageUrl(val) {
      if (!val) return '';
      const fromImg = fromImageFormula(val);
      if (fromImg) val = fromImg;
      if (typeof val !== 'string') return '';
      const trimmed = val.trim();
      const driveId = extractDriveId(trimmed);
      if (driveId) return `https://drive.google.com/uc?export=view&id=${driveId}`;
      if (/^https?:\/\/.+/i.test(trimmed)) return trimmed;
      return '';
    }
    function fmtDate(value) {
      // Accepts Google serials, ISO strings, or already-formatted strings
      if (value == null || value === '') return '';
      // If number-like, treat as Google serial date
      if (!isNaN(value)) {
        const serial = Number(value);
        // Google Sheets serial date origin (Dec 30, 1899)
        const epoch = new Date(Date.UTC(1899, 11, 30));
        const ms = serial * 24 * 60 * 60 * 1000;
        const d = new Date(epoch.getTime() + ms);
        return mmddyyyy(d);
      }
      // Try parsing common strings
      const d2 = new Date(value);
      if (!isNaN(d2)) return mmddyyyy(d2);
      return value; // fallback
    }
    function mmddyyyy(d) {
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const yyyy = String(d.getFullYear());
      return `${mm}/${dd}/${yyyy}`;
    }
    function statusKey(raw) {
      // keep simple mapping so filter works even if sheet has lowercase, etc.
      const t = (raw || '').toString().trim().toUpperCase();
      if (t.startsWith('ACTIVE')) return 'ACTIVE';
      if (t.startsWith('INACTIVE')) return 'INACTIVE';
      return t || 'ACTIVE';
    }
    function initialsFrom(name) {
      return (name || '')
        .split(' ')
        .filter(Boolean)
        .slice(0,2)
        .map(s => s[0]?.toUpperCase())
        .join('') || '—';
    }

    // ========= Data loader =========
    async function loadData() {
      const base = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq`;
      const params = new URLSearchParams({ tqx: 'out:json', tq: 'select *', gid: GID });
      const url = `${base}?${params.toString()}`;

      try {
        const resp = await fetch(url, { cache: 'no-store' });
        const text = await resp.text();
        const match = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);?$/);
        if (!match) throw new Error('Unexpected response format');
        const payload = JSON.parse(match[1]);
        const rows = (payload.table && payload.table.rows) ? payload.table.rows : [];

        // Fixed indices per your header order
        const processed = rows.map(r => {
          const c = r.c || [];
          const safe = i => (c[i]?.v ?? '');
          return {
            id: safe(0),
            name: safe(1),
            status: statusKey(safe(2)),
            status_raw: safe(2),
            dob: safe(3),
            age: safe(4),
            association: safe(5),
            guardian: safe(6),
            warning_expires: safe(7),
            image: normalizeImageUrl(c[8]?.v ?? ''), // column I
            trespassed_from: safe(9),
            contact: safe(10),
            current_school: safe(11),
            picture: normalizeImageUrl(c[12]?.v ?? '')
          };
        })
        // Remove the header row if it leaked in as data (e.g., if the sheet has merged header rows)
        .filter(row => row.id !== 'id' && row.name !== 'Name');

        allData = processed;
        applyFilters();
      } catch (e) {
        console.error(e);
        allData = [];
        applyFilters();
      }
    }

    // ========= Filters =========
    function applyFilters() {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      const statusFilter = document.getElementById('statusSelect').value; // ALL | ACTIVE | INACTIVE

      currentFiltered = allData.filter(p => {
        const statusOK = (statusFilter === 'ALL') ? true : statusKey(p.status) === statusFilter;
        if (!statusOK) return false;
        if (!q) return true;
        const hay = [
          p.name, p.id, p.association, p.guardian, p.trespassed_from, p.contact, p.current_school, p.status_raw
        ].join(' ').toLowerCase();
        return hay.includes(q);
      });

      renderCards(currentFiltered);
      document.getElementById('resultCount').textContent = currentFiltered.length;
    }

    // ========= Render =========
    function renderCards(data) {
      const grid = document.getElementById('trespassGrid');
      if (!data || data.length === 0) {
        grid.innerHTML = '<div class="empty">No matching records</div>';
        return;
      }

      grid.innerHTML = data.map(person => {
        const safe = encodeURIComponent(JSON.stringify(person));
        const initials = initialsFrom(person.name);
        const imgTag = person.image
          ? `<img class="avatar" src="${person.image}" alt="${person.name}" loading="lazy"
                 referrerpolicy="no-referrer"
                 onerror="this.onerror=null;this.replaceWith(this.nextElementSibling.cloneNode(true));" />`
          : '';
        const placeholder = `<div class="avatar avatar--placeholder">${initials}</div>`;
        const status = statusKey(person.status);
        const badgeClass = status === 'ACTIVE' ? 'badge-active' : 'badge-inactive';

        return `
          <div class="trespass-card" onclick="showDetails('${safe}')">
            <div class="card-top">
              ${imgTag}${placeholder}
              <div>
                <div class="card-name">${person.name || '—'}</div>
                <div class="card-line">ID: ${person.id || '—'}</div>
                <div class="card-line">Age: ${person.age || '—'}</div>
                <div class="card-line">Expires: ${fmtDate(person.warning_expires) || '—'}</div>
              </div>
            </div>
            <span class="badge ${badgeClass}">${status}</span>
          </div>
        `;
      }).join('');
    }

    // ========= Modal =========
    function showDetails(personEncoded) {
      const p = JSON.parse(decodeURIComponent(personEncoded));
      const modal = document.getElementById('detailModal');
      const body = document.getElementById('modalBody');
      const title = document.getElementById('modalTitle');

      title.textContent = p.name || 'Details';

      const rows = [
        ['Name', p.name],
        ['ID', p.id],
        ['Status', p.status_raw || p.status],
        ['DOB', fmtDate(p.dob)],
        ['Age', p.age],
        ['Association', p.association],
        ['Guardian', p.guardian],
        ['Warning Expires', fmtDate(p.warning_expires)],
        ['Trespassed From', p.trespassed_from],
        ['Contact', p.contact],
        ['Current School', p.current_school]
      ];

      body.innerHTML = `
        <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
          ${p.image ? `<img class="avatar" src="${p.image}" alt="${p.name}" style="width:72px;height:72px;">` : ''}
          ${p.picture ? `<img class="avatar" src="${p.picture}" alt="${p.name}" style="width:72px;height:72px;">` : ''}
        </div>
        ${rows.map(([k,v]) => `
          <div class="detail-row">
            <div class="detail-key">${k}</div>
            <div>${(v ?? '') === '' ? '—' : v}</div>
          </div>
        `).join('')}
      `;

      modal.classList.add('open');
    }

    function closeModal() {
      document.getElementById('detailModal').classList.remove('open');
    }

    // ========= Boot =========
    document.addEventListener('DOMContentLoaded', () => {
      const searchInput = document.getElementById('searchInput');
      const statusSelect = document.getElementById('statusSelect');
      searchInput.addEventListener('input', () => {
        // debounce not strictly necessary here; small dataset
        applyFilters();
      });
      statusSelect.addEventListener('change', applyFilters);

      document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
      document.getElementById('modalOkBtn').addEventListener('click', closeModal);
      document.getElementById('detailModal').addEventListener('click', (e) => {
        if (e.target.id === 'detailModal') closeModal();
      });

      loadData();
      setInterval(loadData, 60000); // optional refresh
    });
  </script>
</body>
</html>
